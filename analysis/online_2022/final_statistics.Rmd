---
title: "final_statistics"
author: "sherry"
date: "2023-06-19"
output: html_document
---
# setup
## load
```{r}
rm(list=ls())

knitr::opts_chunk$set(echo = FALSE)

library(DHARMa)
library(brms)
library(lmerTest)

pathToFolder <- "/Users/dbao/My_Drive/road_construction/data/2022_online/"
save_folder0 <- file.path(pathToFolder, 'stat_model/')
save_folder <- file.path(pathToFolder, 'stat_model/final/')
```
# Undo benefit
```{r}
load(file.path(save_folder0, 'puzzleID_order_data.RData'))
```

## lme. interaction
```{r}
puzzleID_order_data$undo_used <- as.factor(puzzleID_order_data$undo_used)
puzzleID_order_data$condition <- as.factor(puzzleID_order_data$condition)
  
model_error0 = lme4::glmer(final_sumSeverityErrors ~  1 + undo_used:condition + condition + (1|subjects) + (1|puzzleID), 
                          data = puzzleID_order_data, family = "poisson")

summary(model_error0)
```

```{r}
simulationOutput <- simulateResiduals(fittedModel = model_error0, n = 1000, plot = F)
plot(simulationOutput)
```
## lme. 3 cate
```{r}
model_error1 = lme4::glmer(final_sumSeverityErrors ~  1 + undo_condition_interaction + (1|subjects) + (1|puzzleID) ,  #
                          data = puzzleID_order_data, family = "poisson")

summary(model_error1)
```

```{r}
simulationOutput <- simulateResiduals(fittedModel = model_error1, n = 1000, plot = F)
plot(simulationOutput)
```
## brms. 3 cate
```{r}
model_error_brm = brm(
  final_sumSeverityErrors ~  1 + undo_condition_interaction + (1|subjects)+ (1|puzzleID),
  data = puzzleID_order_data,  family = "zero_inflated_poisson",
  chains = 3, cores = 3, iter = 2000, warmup = 1000)
summary(model_error_brm)
```

```{r}
simulationOutput <- simulateResiduals(fittedModel = model_error_brm, n = 1000, plot = F)
plot(simulationOutput)
```

```{r}
hypothesis(model_error_brm, "undo_condition_interaction1 > undo_condition_interaction2")
hypothesis(model_error_brm, "undo_condition_interaction1 < 0")
```

# Block effect
```{r}
puzzleID_order_data$subjects <- factor(puzzleID_order_data$subjects)
# puzzleID_order_data$block <- factor(puzzleID_order_data$block)
puzzleID_order_data$condition <- factor(puzzleID_order_data$condition)

model_final_sumSeverityErrors <- lme4::glmer(final_sumSeverityErrors ~  1 + block*condition + (1|subjects), data = puzzleID_order_data, family = "poisson")

summary(model_final_sumSeverityErrors)
```

```{r}
simulationOutput <- simulateResiduals(fittedModel = model_final_sumSeverityErrors, n = 1500, plot = F)
plot(simulationOutput)
```

# Undo Initiation
## Error correction efficiency
### Make errors at the beginning
#### Basic condition (supp)
```{r}
load(file.path(save_folder, 'model_error_step_basic_condition.RData'))
simulationOutput <- simulateResiduals(fittedModel = model_error, n = 1000, plot = F)
plot(simulationOutput)
```
#### Undo condition
```{r}
load(file.path(save_folder, 'model_error_step_undo_condition.RData'))
simulationOutput <- simulateResiduals(fittedModel = model_error, n = 1000, plot = F)
plot(simulationOutput)
```
#### Given undo (supp)
```{r}
load(file.path(save_folder, 'model_error_step_given_undo.RData'))
simulationOutput <- simulateResiduals(fittedModel = model_error, n = 1000, plot = F)
plot(simulationOutput)
```
### Undo at the end
#### Across step
```{r}
load(file.path(save_folder, 'model_undo_step.RData'))
simulationOutput <- simulateResiduals(fittedModel = model_undo, n = 1000, plot = F)
plot(simulationOutput)
```
### Sequential - error magnitude
#### Probability
```{r}
load(file.path(save_folder, 'model_undo_error_magnitude.RData'))
simulationOutput <- simulateResiduals(fittedModel = model_undo, n = 1000, plot = F)
plot(simulationOutput)
```

```{r}
load(file.path(save_folder, 'model_sequential_undo_error_magnitude.RData'))
simulationOutput <- simulateResiduals(fittedModel = model_undo, n = 1000, plot = F)
plot(simulationOutput)
```
```{r}
load(file.path(save_folder, 'model_single_undo_error_magnitude.RData'))
simulationOutput <- simulateResiduals(fittedModel = model_undo, n = 1000, plot = F)
plot(simulationOutput)
```
#### Proportion
```{r}
load(file.path(save_folder, 'model_prop_single_undo_error_magnitude.RData'))
simulationOutput <- simulateResiduals(fittedModel = model_undo, n = 1000, plot = F, re.form = NULL) # 
plot(simulationOutput)

testUniformity(simulationOutput) 
testQuantiles(simulationOutput)
```
## Possible cues for error correction
### Achievd score in a puzzle
```{r}
load(file.path(save_folder, 'model_undo_optimal_mas_TT.RData'))
simulationOutput <- simulateResiduals(fittedModel = model_undo, n = 1000, plot = F, re.form = NULL)
plot(simulationOutput)

plot(simulationOutput, form = state_df$TT)
testZeroInflation(simulationOutput)
testQuantiles(simulationOutput)
```
### Remaining budget
```{r}
load(file.path(save_folder, 'model_undo_optimal_mas_TT_budget.RData'))
simulationOutput <- simulateResiduals(fittedModel = model_undo, n = 1000, plot = F, re.form = NULL) #, re.form = NULL
plot(simulationOutput)

plot(simulationOutput, form = state_df$TT)
testZeroInflation(simulationOutput)
testQuantiles(simulationOutput)
```
### Uncertainty
#### First-move RT
```{r}
load(file.path(save_folder, 'model_undo_rt1.RData'))
simulationOutput <- simulateResiduals(fittedModel = model_undo, n = 1000, plot = F) #, re.form = NULL
plot(simulationOutput)

testZeroInflation(simulationOutput)
testQuantiles(simulationOutput)
```

# Undo Completion
## what predicts the undo terminal
```{r}
load(file.path(save_folder, 'model_undo_right_error_and_cumulative.RData'))
simulationOutput <- simulateResiduals(fittedModel = model_undo_right, n = 2000, plot = F) #, re.form = NULL
plot(simulationOutput)

testZeroInflation(simulationOutput)
testQuantiles(simulationOutput)
```

